const DisplayItem = require('../../display-item.js');
const { config } = require('@proceed/machine');

class ConfigTab extends DisplayItem {
  //  Conf
  constructor() {
    super('Configuration', 'configuration');
    this.content = `<!doctype html><html lang="de"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Configuration</title><style>/*!
    Pure v2.0.6
    Copyright 2013 Yahoo!
    Licensed under the BSD License.
    https://github.com/pure-css/pure/blob/master/LICENSE
    */
    /*!
    normalize.css v | MIT License | git.io/normalize
    Copyright (c) Nicolas Gallagher and Jonathan Neal
    */
    /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{-webkit-box-sizing:border-box;box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}html{font-family:sans-serif}.hidden,[hidden]{display:none!important}.pure-img{max-width:100%;height:auto;display:block}.pure-g{letter-spacing:-.31em;text-rendering:optimizespeed;font-family:FreeSans,Arimo,Droid Sans,Helvetica,Arial,sans-serif;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row wrap;flex-flow:row wrap;-ms-flex-line-pack:start;align-content:flex-start}@media (-ms-high-contrast:active),(-ms-high-contrast:none){table .pure-g{display:block}}.opera-only :-o-prefocus,.pure-g{word-spacing:-.43em}.pure-u{display:inline-block;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-g [class*=pure-u]{font-family:sans-serif}.pure-u-1,.pure-u-1-1,.pure-u-1-2,.pure-u-1-3,.pure-u-1-4,.pure-u-1-5,.pure-u-1-6,.pure-u-1-8,.pure-u-1-12,.pure-u-1-24,.pure-u-2-3,.pure-u-2-5,.pure-u-2-24,.pure-u-3-4,.pure-u-3-5,.pure-u-3-8,.pure-u-3-24,.pure-u-4-5,.pure-u-4-24,.pure-u-5-5,.pure-u-5-6,.pure-u-5-8,.pure-u-5-12,.pure-u-5-24,.pure-u-6-24,.pure-u-7-8,.pure-u-7-12,.pure-u-7-24,.pure-u-8-24,.pure-u-9-24,.pure-u-10-24,.pure-u-11-12,.pure-u-11-24,.pure-u-12-24,.pure-u-13-24,.pure-u-14-24,.pure-u-15-24,.pure-u-16-24,.pure-u-17-24,.pure-u-18-24,.pure-u-19-24,.pure-u-20-24,.pure-u-21-24,.pure-u-22-24,.pure-u-23-24,.pure-u-24-24{display:inline-block;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-1-24{width:4.1667%}.pure-u-1-12,.pure-u-2-24{width:8.3333%}.pure-u-1-8,.pure-u-3-24{width:12.5%}.pure-u-1-6,.pure-u-4-24{width:16.6667%}.pure-u-1-5{width:20%}.pure-u-5-24{width:20.8333%}.pure-u-1-4,.pure-u-6-24{width:25%}.pure-u-7-24{width:29.1667%}.pure-u-1-3,.pure-u-8-24{width:33.3333%}.pure-u-3-8,.pure-u-9-24{width:37.5%}.pure-u-2-5{width:40%}.pure-u-5-12,.pure-u-10-24{width:41.6667%}.pure-u-11-24{width:45.8333%}.pure-u-1-2,.pure-u-12-24{width:50%}.pure-u-13-24{width:54.1667%}.pure-u-7-12,.pure-u-14-24{width:58.3333%}.pure-u-3-5{width:60%}.pure-u-5-8,.pure-u-15-24{width:62.5%}.pure-u-2-3,.pure-u-16-24{width:66.6667%}.pure-u-17-24{width:70.8333%}.pure-u-3-4,.pure-u-18-24{width:75%}.pure-u-19-24{width:79.1667%}.pure-u-4-5{width:80%}.pure-u-5-6,.pure-u-20-24{width:83.3333%}.pure-u-7-8,.pure-u-21-24{width:87.5%}.pure-u-11-12,.pure-u-22-24{width:91.6667%}.pure-u-23-24{width:95.8333%}.pure-u-1,.pure-u-1-1,.pure-u-5-5,.pure-u-24-24{width:100%}button{color:#000;background-color:#fff;border-radius:.2rem;border:.1rem solid grey;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);font-size:100%;padding:.5rem 1rem;text-decoration:none;display:inline-block;line-height:normal;white-space:nowrap;vertical-align:middle;text-align:center;cursor:pointer;-webkit-user-drag:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-box-sizing:border-box;box-sizing:border-box;-webkit-appearance:button;text-transform:none;overflow:visible}button:hover{background-color:#fefffd;background-image:-webkit-gradient(linear,left top,left bottom,from(transparent),color-stop(40%,rgba(0,0,0,.05)),to(rgba(0,0,0,.1)));background-image:linear-gradient(transparent,rgba(0,0,0,.05) 40%,rgba(0,0,0,.1))}button:active{-webkit-box-shadow:0 0 0 1px rgba(0,0,0,.15) inset,0 0 6px rgba(0,0,0,.2) inset;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15),inset 0 0 6px rgba(0,0,0,.2);border-color:#000}button:focus{outline:0}.primary{background:#0094a0;color:#fff}button.primary:hover{background-color:#00b8c9}.secondary{background:#574f4f;color:#fff}button.secondary:hover{background-color:#272727}.success{background:#4caf50}button.success:hover{background-color:#67dc6b}.info{background-color:#2196f3;color:#fff}button.info:hover{background-color:#0084f0}.warning{background:#fb8c00}button.warning:hover{background-color:#e97115}.error{background:#e64242;color:#fff}button.error:hover{background-color:#ff1e1e}input,select,textarea{background-color:transparent;border-style:none;border-radius:0}input{border-bottom:.1em solid rgba(0,0,0,.8);min-height:2em;-webkit-rtl-ordering:logical;writing-mode:horizontal-tb;-webkit-writing-mode:horizontal-tb;text-rendering:auto;letter-spacing:normal;word-spacing:normal;text-transform:none;text-indent:0;text-shadow:none;display:inline-block;text-align:start}input:active,input:focus{border-bottom:.2em solid #0094a0;caret-color:#0094a0;outline:none}input[type=text]{min-width:25rem}input[type=checkbox]{min-width:1.5rem;cursor:pointer}#root{border:.1rem solid hsla(0,0%,40.8%,.1);margin:1rem}#header{margin:1rem 0}.config-sub-object-title{text-align:center;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;min-height:3rem;border-bottom:.1rem solid #d3d3d3;align-items:center;display:flex;flex:1 1 100%}.title{flex:1}.config-sub-object-title:hover{background-color:#f7f7f7}.config-sub-object-title:focus{background-color:#d3d3d3}.config-sub-object-title .menuIconArrowDown{float:right;margin-right:1rem}.array-node-body,.config-sub-object-body{background-color:hsla(0,0%,74.5%,.1)}.noshow{display:none}.show{display:block}.input-line{margin-bottom:1rem;text-align:center;display:flex;flex-wrap:wrap;align-items:center}.input-label-cell{box-sizing:border-box;padding-right:1rem;text-align:right}.input-label-cell+.input-input-cell{box-sizing:border-box;text-align:left;padding-left:1rem}.array-node-title{cursor:pointer;min-height:3rem;text-align:center;display:flex;flex-wrap:wrap;justify-content:space-evenly;align-items:center}.array-node-title:hover{background-color:hsla(0,0%,60.8%,.1)}.array-node-title:focus{background-color:#d3d3d3}.menuIconArrowDown{margin-left:1rem}.array-node-body{background-color:#fcfcfc;margin:0 .5rem}.array-node-body .input-input-cell{text-align:right;box-sizing:border-box;padding-right:1rem}.input-remove-cell{cursor:pointer;text-align:center;box-sizing:border-box;padding-left:1rem;color:#e64242;font-size:1.5rem}.array-node-add{text-align:center}.back-arrow{height:100%;font-weight:700}</style></head><body><div id="header" class="pure-g" role="group" aria-label="Configuration buttons"><div class="pure-u-1-24"></div><button class="pure-u-6-24 secondary" onclick="onDeleteUserConfig()">Restore Defaults</button><div class="pure-u-2-24"></div><button class="pure-u-6-24 secondary" onclick="onRefreshData()">Reload</button><div class="pure-u-2-24"></div><button class="pure-u-6-24 primary" onclick="onWriteUserConfig()">Submit</button><div class="pure-u-1-24"></div></div><div id="root"></div><script>!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);n(0),n(1),n(2),n(3),n(4),n(5);function o(e,t,n){let o=document.createElement(t);return e&&e.appendChild(o),n&&Object.keys(n).forEach((function(e){o.setAttribute(e,n[e])})),o}let i,r=document.getElementById("root");function c(){r&&PROCEED_DATA.get("/configuration/api/config",{}).then(e=>l(e))}function l(e){var t,n;i=e,r.innerHTML="",t=r,n=i,Object.entries(n).filter(([e,t])=>"object"!=typeof t).forEach(([e,o])=>{a(t,e,o,t=>{n[e]=t})}),Object.entries(n).filter(([e,t])=>t&&"object"==typeof t).forEach(([e,n])=>{Array.isArray(n)?f(t,e,n):u(t,e,n)})}function a(e,t,n,i){let r;const c=t,l=o(e,"div",{class:"input-line pure-g"});if(t){o(l,"label",{class:"input-label-cell pure-u-1-2",for:c}).textContent=t+":"}const a=o(l,"div",{class:"input-input-cell pure-u-1-2"});return t||(a.style.maxWidth="100%"),function(e){switch(typeof e){case"boolean":r=o(a,"input",{type:"checkbox",class:"booleanInput",id:c}),e&&r.setAttribute("checked",!0),r.onchange=function(){i(Boolean(r.checked))};break;case"string":r=o(a,"input",{type:"text",class:"stringInput",value:e,id:c}),r.onchange=function(){i(String(r.value))};break;case"number":r=o(a,"input",{type:"number",class:"numberInput",value:e,id:c}),r.onchange=function(){i(Number(r.value))}}}(n),l}function s(e,t){const n=t.querySelector(".content-container");n.classList.toggle("show"),n.classList.toggle("noshow");if(e.getBoundingClientRect().width>720||r.firstChild===t)return;const o=r.querySelector("div"),i=t.parentNode,c=Array.prototype.indexOf.call(i.children,t);r.removeChild(o),r.appendChild(t);const l=t.querySelector(".title-container"),a=l.querySelector(".title"),s=document.createElement("div");s.classList.add("back-arrow"),s.innerHTML="&larr;",l.insertBefore(s,a),s.onclick=e=>{if(r.removeChild(t),r.appendChild(o),c===i.children.length)i.appendChild(t);else{const e=Array.from(i.children)[c];i.insertBefore(t,e)}l.removeChild(s),n.classList.remove("show"),e.stopPropagation()}}function u(e,t,n){const i=o(e,"div",{class:"container config-sub-object"}),r=o(i,"div",{class:"title-container config-sub-object-title"}),c=o(r,"div",{class:"title"});c.textContent=t;o(c,"span",{class:"menuIconArrowDown"}).textContent="▾";const l=o(i,"div",{class:"content-container config-sub-object-body noshow"});r.onclick=()=>{s(e,i)},function(e,t){Object.entries(t).forEach(([n,o])=>{if(o&&"object"==typeof o)Array.isArray(o)?f(e,n,o):u(e,n,o);else{a(e,n,o,e=>{t[n]=e})}})}(l,n)}function f(e,t,n){const i=o(e,"div",{class:"container array-node pure-g"}),r=o(i,"div",{class:"title-container array-node-title pure-u-1"}),c=o(r,"div",{class:"title"});c.textContent=t;o(c,"span",{class:"menuIconArrowDown"}).textContent="▾";const l=o(i,"div",{class:"content-container array-node-body pure-u-1 noshow"});r.onclick=()=>{s(e,i)};const u=o(l,"div",{class:"array-node-content"}),f=o(l,"div",{class:"array-node-add"});f.textContent="[+]";let d=[];const p=function(e,t,i){d[t]=e;const r=a(u,void 0,i,e=>{n[d[t]]=e}),c=o(r,"div",{class:"input-remove-cell pure-u-3-24"});c.textContent="x",c.onclick=()=>{u.removeChild(r),n.splice(d[t],1),d=d.map(e=>e>d[t]?--e:e)}};n.forEach((e,t)=>{p(t,t,e)}),f.onclick=()=>{const e=n.length,t=d.length;d.push(e),n.push(""),p(e,t,"")}}window.onDeleteUserConfig=function(){PROCEED_DATA.post("/configuration/api/config").then(e=>l(e))},window.onWriteUserConfig=function(){PROCEED_DATA.post("/configuration/api/config",i).then(e=>l(e))},window.onRefreshData=c,c()}]);</script></body></html>`;
  }

  getEndpoints() {
    return {
      // GET <engine>/configuration/api/config ('configuration' comes from DisplayItem.key)
      '/api/config': { get: this.getConfig.bind(this), post: this.writeConfig.bind(this) },
    };
  }
  async getConfig() {
    return await config.readConfig();
  }

  async writeConfig(body, query) {
    if (Object.keys(body).length === 0) return await config.writeConfig({}, true);
    //delete config vals
    else {
      return await config.writeConfig(body);
    }
  }
}

module.exports = ConfigTab;
